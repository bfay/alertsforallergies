Object.extend(Prototype.Browser,{ie6:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===6?true:false):false,ie7:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===7?true:false):false,ie8:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===8?true:false):false,ie9:(/MSIE (\d+\.\d+);/.test(navigator.userAgent))?(Number(RegExp.$1)===9?true:false):false});Event.cacheDelegated={};Object.extend(document,(function(){var b=Event.cacheDelegated;function d(g){return b[g]=b[g]||{}}function a(g,h){var i=d(g);return i[h]=i[h]||[]}function c(g,h,i){var j=a(g,h);return j.find(function(k){return k.handler===i})}function f(g,h,i){var k=d(g);if(!k[h]){return false}var j=c(g,h,i);k[h]=k[h].without(j);return j}function e(g,h,j,i){var l,k=a(g,h);if(k.pluck("handler").include(j)){return false}l=function(n){var m=n.findElement(g);if(m){j.call(i||m,n,m)}};l.handler=j;k.push(l);return l}return{delegate:function(g,h,j,i){var k=e.apply(null,arguments);if(k){document.observe(h,k)}return document},stopDelegating:function(g,i,j){var h=arguments.length;switch(h){case 2:a(g,i).each(function(l){document.stopDelegating(g,i,l.handler)});break;case 1:Object.keys(d(g)).each(function(l){document.stopDelegating(g,l)});break;case 0:Object.keys(b).each(function(l){document.stopDelegating(l)});break;default:var k=f.apply(null,arguments);if(k){document.stopObserving(i,k)}}return document}}})());var Observable=(function(){function d(e,f){e=e.substring(2);if(f){e=f+":"+e}return e.underscore().split("_").join(":")}function b(e){var g=e.prototype,f=g.namespace;return Object.keys(g).grep(/^on/).inject($H(),function(h,i){if(i==="onDomLoaded"){return h}h.set(d(i,f),a(g[i],e));return h})}function a(f,e){return function(g){return f.call(new e(this),g,g.memo)}}function c(f,e){$$(f).each(function(g){new e(g).onDomLoaded()})}return{observe:function(f){if(!this.handlers){this.handlers={}}if(this.handlers[f]){return}var e=this;if(this.prototype.onDomLoaded){document.loaded?c(f,e):document.observe("dom:loaded",c.curry(f,e))}this.handlers[f]=b(e).each(function(g){document.delegate(f,g.key,g.value)})},stopObserving:function(e){if(!this.handlers||!this.handlers[e]){return}this.handlers[e].each(function(f){document.stopDelegating(e,f.key,f.value)});delete this.handlers[e]}}})();Object.extend(Droppables,{deactivate:Droppables.deactivate.wrap(function(a,b,c){if(b.onLeave){b.onLeave(c,b.element)}return a(b)}),activate:Droppables.activate.wrap(function(a,b,c){if(b.onEnter){b.onEnter(c,b.element)}return a(b)}),show:function(a,c){if(!this.drops.length){return}var b,d=[];this.drops.each(function(e){if(Droppables.isAffected(a,c,e)){d.push(e)}});if(d.length>0){b=Droppables.findDeepestChild(d)}if(this.last_active&&this.last_active!=b){this.deactivate(this.last_active,c)}if(b){Position.within(b.element,a[0],a[1]);if(b.onHover){b.onHover(c,b.element,Position.overlap(b.overlap,b.element))}if(b!=this.last_active){Droppables.activate(b,c)}}},displayArea:function(b){if(!this.drops.length){return}var a;this.drops.each(function(c){if(c.element.hasClassName("block_placeholder")){a=b.element.getHeight();c.element.resizeHeight(((a>30)?30:a));c.element.addClassName("active")}else{if(c.element.hasClassName("image_placeholder")){if(b.element.hasClassName("wysija_widget")&&b.element.hasClassName("image")){c.element.addClassName("active");c.element.up().addClassName("active")}}else{if(c.element.hasClassName("text_placeholder")){if(b.element.hasClassName("wysija_widget")&&b.element.hasClassName("text")){try{var f=c.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.contentAlignment;if(f==="center"){c.element.resizeHeight(30)}else{a=c.element.up(".wysija_content").down(".wysija_image img").getHeight();if(c.element.getHeight()<a){c.element.resizeHeight(a-2)}}}catch(d){}c.element.addClassName("active")}}}}})},hideArea:function(){if(!this.drops.length){return}var a;this.drops.each(function(b){if(b.element.hasClassName("block_placeholder")){b.element.resizeHeight(0);b.element.removeClassName("active")}else{if(b.element.hasClassName("image_placeholder")){b.element.removeClassName("active");b.element.up().removeClassName("active")}else{if(b.element.hasClassName("text_placeholder")){b.element.removeClassName("active")}}}})},reset:function(a){if(this.last_active){this.deactivate(this.last_active,a)}}});Element.addMethods({resizeHeight:function(b,d,c,a){return new Effect.Morph(b,{style:{height:parseInt(d)+"px"},afterUpdate:c,afterFinish:a,duration:0.2})},scrollToCenter:function(a,b){var a=$(a);var c=Object.extend({duration:0.2,offset:-document.viewport.getHeight()/2},b||{});Effect.ScrollTo(a,c);return a}});var Wysija={version:"2.0",options:{debug:false,toolbar:"wysija_toolbar",wrapper:"wysija_wrapper",container:"wysija_container",header:"wysija_header",body:"wysija_body",footer:"wysija_footer"},dragging:false,defaults:{contentAlignment:"left",imageAlignment:"center",galleryAlignment:"center"},doSave:false,autoSave:function(){if(Wysija.doSave===false){Wysija.doSave=true}return},save:function(){var g,b,d={},c=$H();c.set("version",Wysija.version);var f=Wysija.getHeader();d=f.block.save();d.type="header";c.set("header",d);var a=$H();Wysija.getBlocks().each(function(h){g=h.block;if(g.save){d=g.save();if(d!=null){b=g.element.readAttribute("wysija_position");d.position=b;d.type=h.elementType;a.set("block-"+b,d)}}});c.set("body",a);var e=Wysija.getFooter();d=e.block.save();d.type="footer";c.set("footer",d);return Object.toJSON(c)},blockDropOptions:{accept:$w("wysija_widget"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(b,c){var a={};a.elementType=b.readAttribute("wysija_type");a.element=b;if(a.elementType==="image"){a.elementRatio=b.readAttribute("elementRatio");a.elementSrc=b.readAttribute("wysija_src");a.elementWidth=b.readAttribute("wysija_width");a.elementHeight=b.readAttribute("wysija_height");a.elementClass=null}else{if(a.elementType==="divider"){a.elementSrc=b.readAttribute("wysija_src");a.elementWidth=b.readAttribute("wysija_width");a.elementHeight=b.readAttribute("wysija_height")}else{if(a.elementType==="text"){a.elementText=Wysija_i18n.clickToEditText}}}c.fire("item:drop",a);$(c).removeClassName("hover")}},imageDropOptions:{accept:$w("image"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(b,c){var a={};a.elementType=b.readAttribute("wysija_type");a.element=b;a.elementRatio=b.readAttribute("elementRatio");a.elementSrc=b.readAttribute("wysija_src");a.elementWidth=b.readAttribute("wysija_width");a.elementHeight=b.readAttribute("wysija_height");a.elementClass=null;c.fire("image:drop",a);$(c).removeClassName("hover")}},textDropOptions:{accept:$w("text"),onEnter:function(a,b){$(b).addClassName("hover")},onLeave:function(a,b){$(b).removeClassName("hover")},onDrop:function(b,c){var a={};a.elementType=b.readAttribute("wysija_type");a.element=b;a.elementText=Wysija_i18n.clickToEditText;c.fire("text:drop",a);$(c).removeClassName("hover")}},instances:{},get:function(b,c){if(c===undefined){c="block"}var d=b.identify();var a=Wysija.instances[d]||new Wysija[c.capitalize().camelize()](d);Wysija.instances[d]=a;return a},getTheme:function(){var a=$("wysija_widgets_settings").down(".theme");if(a!==undefined&&a.innerHTML.length>0){return a.innerHTML}return"default"},getHeader:function(){return Wysija.get(Wysija.getHeaderElement(),"header")},getHeaderElement:function(){return $$("div.wysija_header")[0]},getFooter:function(){return Wysija.get(Wysija.getFooterElement(),"footer")},getFooterElement:function(){return $$("div.wysija_footer")[0]},getBlocks:function(){return Wysija.getBlockElements().map(function(a){return Wysija.get(a)})},getBlockElements:function(){return $$("div.wysija_block")},setBlockPositions:function(b,c){Wysija.dragging=false;var a=1;Wysija.getBlocks().each(function(d){d.setPosition(a++)});if(c!==undefined){if($$(".wysija_auto-post").length>1){if(c.element.readAttribute("wysija_type")==="auto-post"){Wysija.initAutoPost()}}}Wysija.autoSave()},startBlockPositions:function(){Wysija.dragging=true;Wysija.hideEditors()},init:function(){Wysija.getHeader();Wysija.getFooter();Wysija.makeDroppable();Wysija.makeSortable();Wysija.hideControls();Wysija.hideTools();Wysija.hideSettings();Wysija.setSettingsPosition();Wysija.initSettings();Wysija.initAutoPost();$(Wysija.options.toolbar).setStyle({top:parseInt($(Wysija.options.wrapper).positionedOffset().top+25)+"px"});Wysija.setBlockPositions()},setBackgroundColors:function(){Wysija.getBlocks().invoke("setBackgroundColor")},hideBlockControls:function(){$$(".wysija_controls").invoke("hide");this.getBlockElements().invoke("removeClassName","hover")},hideEditors:function(){$$(".wysija_text").invoke("setStyle",{width:"auto","float":"none"});if(tinymce.editors.length>0){Wysija.getBlocks().each(function(a){if(a.elementType==="content"&&a.block.contents!=null){a.block.contents.disableEditor()}})}},hideControls:function(){return Wysija.getBlocks().invoke("hideControls")},hideTools:function(){$$(".resize-controls").invoke("hide");$$(".wysija_tools").invoke("hide")},makeDroppable:function(){Droppables.add("block_placeholder",Wysija.blockDropOptions)},makeSortable:function(){var a=$(Wysija.options.body);Sortable.create(a,{tag:"div",only:"wysija_block",scroll:window,handle:"handle",constraint:"vertical"});Draggables.removeObserver(a);Draggables.addObserver({element:a,onStart:Wysija.startBlockPositions,onEnd:Wysija.setBlockPositions})},setDivider:function(b,a){$("wysija_widgets_settings").down(".divider").update(b);$$('.wysija_item[wysija_type="divider"]')[0].writeAttribute("wysija_src",a.src);$$('.wysija_item[wysija_type="divider"]')[0].writeAttribute("wysija_width",a.width);$$('.wysija_item[wysija_type="divider"]')[0].writeAttribute("wysija_height",a.height)},replaceDividers:function(){$$(".wysija_block .wysija_divider").invoke("replace",$("wysija_widgets_settings").down(".divider").innerHTML)},flyToTheMoon:function(){if($("wysija-konami")){var a=document.viewport.getDimensions();var b=a.width;$("wysija-konami-overlay").show();$("wysija-konami-bird").show();$("wysija-konami-bird").setStyle({left:"-1000px",top:"100px"});new Effect.Morph("wysija-konami-bird",{style:{left:b+"px"},duration:5,beforeStart:function(){},afterFinish:function(){$("wysija-konami-bird").writeAttribute("style","z-index:99999;position:absolute;top:300px;left:"+b+'px;-moz-transform: scaleX(-1);-o-transform: scaleX(-1);-webkit-transform: scaleX(-1);transform: scaleX(-1);filter: FlipH;-ms-filter: "FlipH";')}});new Effect.Morph("wysija-konami-bird",{queue:"end",style:{left:"-1000px"},duration:5,afterFinish:function(){$("wysija-konami-bird").writeAttribute("style","z-index:99999;position:absolute;top:100px;left:-1000px;");$("wysija-konami-overlay").hide();$("wysija-konami-bird").hide()}})}else{alert("no konami stuff to move")}},hideSettings:function(){$$(".wysija_settings").invoke("hide")},initSettings:function(){Event.stopObserving("scroll");Event.observe(window,"scroll",function(){Wysija.setSettingsPosition()})},setSettingsPosition:function(){var a=document.viewport.getScrollOffsets(),b=document.viewport.getHeight(),c=25;$$(".wysija_settings").each(function(k){var j=k.up(".wysija_block").getDimensions(),l=k.up(".wysija_block").cumulativeOffset(),d=(l.top<=(a.top+b))?true:false,h=100;if(d){var g=a.top+((b/2)-(k.getHeight()/2)),i=parseInt(l.top-c),f=parseInt(l.top+j.height-c);if(parseInt(j.height)<200){h=parseInt((j.height/2)-(k.getHeight()/2))}else{if((g+100)>=f){h=parseInt(j.height-100)}else{if((g-100)<=i){h=100}else{h=parseInt(g-l.top)}}}}k.setStyle({top:h+"px",left:parseInt((j.width/2)-(k.getWidth()/2))+"px"})})},initAutoPost:function(){info("init -> autopost");var a=$("wysija_widgets_settings").down(".autopost").innerHTML,b=$$(".wysija_auto-post").length;if(a==="single"){if(b>0){$("wysija-widget-autopost").addClassName("disabled");$("wysija-widget-autopost").writeAttribute("title",Wysija_i18n.autoPostImmediateNotice)}else{$("wysija-widget-autopost").removeClassName("disabled");$("wysija-widget-autopost").writeAttribute("title","")}}Wysija.getBlocks().each(function(c){if(c.elementType==="auto-post"){c.block.loadContent()}})},encodeURIComponent:function(a){return encodeURIComponent(a).replace(/[!'()*]/g,escape)}};document.observe("dom:loaded",Wysija.init);Wysija.Block=Class.create({initialize:function(a){info("block -> init");this.element=$(a);this.elementType=this.element.readAttribute("wysija_type");this.block=new Wysija[this.elementType.capitalize().camelize()](this.element);if(parseInt(this.element.readAttribute("wysija_new"))===1){this.block.draw();this.element.writeAttribute("wysija_new",0)}this.block.makeBlockDroppable();this.block.setup();return this},getCustomData:function(a){try{info("got options for "+a);return this.element.down(".wysija_options."+a).innerHTML.toQueryParams("&amp;")}catch(b){info("[ERROR] -> no options to get for "+a);return null}},getOptions:function(){return this.options},setOptions:function(a){if(a===undefined){a={}}if(this.options===undefined){this.options=new Hash()}this.options=this.options.update(a);return this},setPosition:function(a){this.element.writeAttribute("wysija_position",a)},hideControls:function(){if(this["getControls"]){this.getControls().hide()}},showControls:function(){if(this["getControls"]){this.getControls().show()}},makeBlockDroppable:function(){if(this.isBlockDroppableEnabled()===false){Droppables.add(this.getBlockDroppable().identify(),Wysija.blockDropOptions);this.getBlockDroppable().addClassName("enabled")}},removeBlockDroppable:function(){if(this.isBlockDroppableEnabled()){Droppables.remove(this.getBlockDroppable().identify());this.getBlockDroppable().removeClassName("enabled")}},isBlockDroppableEnabled:function(){if(this.element.hasClassName("static")){return true}if(this.getBlockDroppable()===undefined){this.createBlockDroppable()}return this.getBlockDroppable().hasClassName("enabled")},createBlockDroppable:function(){info("block -> createBlockDroppable");this.element.insert({top:'<div class="block_placeholder"></div>'})},getBlockDroppable:function(){return this.element.down(".block_placeholder")},duplicateBlock:function(){},getControls:function(){return this.element.down(".wysija_controls")},setupControls:function(){this.controls=this.getControls();if(this.controls){this.removeButton=this.controls.down(".remove");this.removeButton.observe("click",function(){this.removeBlock();this.removeButton.stopObserving("click")}.bind(this))}return this},editBackgroundColor:function(){},setBackgroundColor:function(){var a=this.element.readAttribute("wysija_bg_color");if(a!==null){this.element.setStyle({backgroundColor:"#"+a})}},removeBlock:function(a){info("block -> removeBlock");Wysija.instances[this.element.identify()]=null;this.element.blindUp({duration:0.2,afterFinish:function(b){b.element.remove();Wysija.setBlockPositions();if(a!==undefined){a()}}})},setFocus:function(){this.element.scrollToCenter()}});document.observe("item:drop",function(a){Wysija.Block.create(a.memo,a.target)});Wysija.Block.create=function(c,f){var d='<li><a class="handle" href="javascript:;"><span></span></a></li><li><a class="remove" href="javascript:;"><span></span></a></li>';if(c.elementType==="image"){c.elementOptions='<span class="wysija_options image">#{options}</span>'.interpolate({options:Object.toQueryString(c)});c.elementType="content";c.blockAlignment=Wysija.defaults.imageAlignment}if(c.elementType==="text"){c.elementOptions='<span class="wysija_options text">#{options}</span>'.interpolate({options:Object.toQueryString(c)});c.elementType="content";c.blockAlignment=Wysija.defaults.contentAlignment}if(c.elementType==="divider"){c.elementOptions='<span class="wysija_options divider">#{options}</span>'.interpolate({options:Object.toQueryString(c)})}var e,a=$(Wysija.options.body),b=new Template('<div class="wysija_block" wysija_type="#{elementType}" wysija_new="1"><ul class="wysija_controls">'+d+'</ul>#{elementOptions}<div class="wysija_#{elementType} #{blockAlignment}"></div></div>');if(f.identify()==="block_placeholder"){a.insert(b.evaluate(c));e=a.childElements().last()}else{f.up(".wysija_block").insert({before:b.evaluate(c)});e=f.up(".wysija_block").previous(".wysija_block")}Wysija.makeSortable();Wysija.setBlockPositions();content=Wysija.get(e);content.block.setFocus();content.element.fire("block:insert");if(content.block.contents!=undefined&&content.block.contents.isEmpty()===false){content.block.contents.setFocus()}};Wysija.Header=Class.create({initialize:function(a){this.element=$(a);this.block=new Wysija.Banner(this.element);this.block.setup();return this}});Wysija.Footer=Class.create({initialize:function(a){this.element=$(a);this.block=new Wysija.Banner(this.element);this.block.setup();return this}});Wysija.Banner=Class.create(Wysija.Block,{image:null,constraints:{left:{minWidth:32,maxWidth:600},right:{minWidth:32,maxWidth:600},center:{minWidth:32,maxWidth:600},full:{maxWidth:600}},initialize:function(a){this.element=$(a);this.elementArea=this.element.readAttribute("wysija_type");if(this.getImageContainer()){this.image=new Wysija.BannerImage(this.getImageContainer(),this.elementArea)}return this},save:function(){var a={};a.text=null;if(this.image!=null){a.image=this.image.save();if(this.image.isEmpty()===false){a.alignment=a.image["alignment"]}else{a.alignment="center"}a["static"]=(this.element.hasClassName("static"))}return a},draw:function(){if(this.image===null){this.element.childElements().last().insert(this.drawContainer("image"));this.image=new Wysija.BannerImage(this.getImageContainer(),this.elementArea);this.image.setOptions(this.getCustomData("image"));this.getImageContainer().insert(this.image.draw())}return this},drawContainer:function(a){return'<div class="wysija_'+a+'"></div>'},getImageContainer:function(){return this.element.down(".wysija_image")},getContainer:function(){return this.element.down(".wysija_content")},minWidth:function(){return this.constraints[this.alignment].minWidth},maxWidth:function(){return this.constraints[this.alignment].maxWidth},fullWidth:function(){return this.constraints.full.maxWidth},setup:function(){if(this.image!=null){this.image.setup()}this.constrainSize()},getControls:function(){return this.element.down(".wysija_controls")},remove:function(a){if(this.image.isEmpty()){$("wysija_"+this.elementArea).innerHTML=$("wysija_default_"+this.elementArea).innerHTML;Wysija.init()}},setBlockAlignment:function(a){info("content -> set block alignment");this.getContainer().removeClassName("left").removeClassName("center").removeClassName("right");this.getContainer().writeAttribute("wysija_align",a);this.getContainer().addClassName(a);if(this.image!=null){this.image.setAlignment(a);this.image.updateDisplay()}this.constrainSize();Wysija.autoSave();return this},constrainSize:function(){info("banner -> constrain size");this.image.ratio=this.image.getRatio();var b=this.image.minSize(),a=this.image.maxSize(),c=this.image.getImageElement();if(c.width>a.width||c.height>a.height){this.image.getImageContainer().writeAttribute("style","");c.writeAttribute({width:a.width,height:a.height})}else{if(c.width<b.width||c.height<b.height){this.image.getImageContainer().writeAttribute("style","");c.writeAttribute({width:b.width,height:b.height})}}if(this.image.alignment==="center"){this.image.getImageContainer().setStyle({width:c.readAttribute("width")+"px"})}else{this.image.getImageContainer().setStyle({width:"auto"})}},getBlock:function(){return this.element.up(".wysija_"+this.elementArea)}});Wysija.Gallery=Class.create(Wysija.Block,{items:$H(),constraints:{left:{minWidth:16,maxWidth:564},right:{minWidth:16,maxWidth:564},center:{minWidth:16,maxWidth:564}},initialize:function(c){info("gallery -> init");this.element=$(c);this.alignment=this.getDefaultAlignment();var b=this.getCells(),e=this.element.identify(),a=[];for(var d=0;d<b.length;d++){a[d]=new Wysija.GalleryImage(b[d])}this.items.set(e,a);return this},getDefaultAlignment:function(){return this.getGalleryElement().readAttribute("wysija_align")||Wysija.defaults.galleryAlignment},draw:function(){info("gallery -> draw")},setup:function(){info("gallery -> setup");this.createResizeControls();this.setupResizeControls();this.setupControls();this.setupTools();this.setBlockAlignment(this.getDefaultAlignment());this.items.get(this.element.id).each(function(a){a.setup()},this)},save:function(){info("gallery -> save");var a={};a.width=this.getGalleryElement().getWidth();a.alignment=this.alignment;a.items=[];this.items.get(this.element.id).each(function(b){a.items.push(b.save())},this);return a},setupTools:function(){this.tools=this.getTools();if(this.tools){this.leftButton=this.tools.down(".alignment-left");this.leftButton.observe("click",function(){this.setBlockAlignment("left")}.bind(this));this.centerButton=this.tools.down(".alignment-center");this.centerButton.observe("click",function(){this.setBlockAlignment("center")}.bind(this));this.rightButton=this.tools.down(".alignment-right");this.rightButton.observe("click",function(){this.setBlockAlignment("right")}.bind(this));this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(){this.remove()}.bind(this))}},remove:function(){this.items.unset(this.element.id);this.removeBlock()},getTools:function(){return this.getGalleryElement().down(".wysija_tools")},hideTools:function(){this.getTools().hide();if(this.information!=undefined){this.information.hide()}},showTools:function(){this.getTools().show();if(this.information!=undefined){this.information.show()}},setBlockAlignment:function(a){info("gallery -> setBlockAlignment");this.getGalleryElement().removeClassName("left").removeClassName("center").removeClassName("right");this.getGalleryElement().writeAttribute("wysija_align",a);this.getGalleryElement().addClassName(a);this.alignment=a;this.leftButton.removeClassName("active");this.centerButton.removeClassName("active");this.rightButton.removeClassName("active");this[a+"Button"].addClassName("active");this.constrainSize();Wysija.autoSave();return this},constrainSize:function(){info("gallery -> constrainSize");var b=this.getGalleryElement().getDimensions();var a=this.getCells(0).length;var c=b.width-this.minWidth();this.getCells().each(function(d){d.setStyle({width:(d.down("img").getWidth()+Math.floor(c/a))+"px"})})},getCells:function(a){a=a|0;return this.getGalleryElement().select(".wysija_row")[a].select(".wysija_cell")},minWidth:function(){info("gallery -> minWidth");return this.getCells(0).inject(0,function(b,a){return b+a.down("img").getWidth()})},maxWidth:function(){return this.constraints[this.alignment].maxWidth},maxHeight:function(){return this.getCells(0).first().getHeight()},setupResizeControls:function(){this.handle=this.getResizeControls().down(".resize-handle");this.information=this.getResizeControls().down(".resize-info");this.handleSize=this.handle.getDimensions();this.draggable=new Draggable(this.handle,{onStart:this.dragStart.bind(this),snap:this.dragSnap.bind(this),change:this.dragChange.bind(this),onEnd:this.dragEnd.bind(this),starteffect:false,endeffect:false});return this},dragStart:function(){Wysija.hideEditors();this.dragging=true;Wysija.dragging=true;$$("body")[0].setStyle({cursor:this.handle.getStyle("cursor")});if(this.alignment==="right"){this.getGalleryElement().insert(this.handle)}},dragSnap:function(a,h,g){var b=this.minWidth(),f=this.maxWidth();if(this.alignment==="right"){var c=this.getGalleryElement().getWidth(),e=c-a;if(e>f){a=c-f;e=f}if(e<b){a=c-b;e=b}h=Math.floor(this.maxHeight()-this.handleSize.height+this.borderWidth())}else{var e=a+this.handleSize.width;if(e>f){a=f-this.handleSize.width;e=f}if(e<b){a=b-this.handleSize.width;e=b}h=Math.floor(this.maxHeight()-this.handleSize.height+this.borderWidth())}return[a,h]},dragChange:function(c,b){if(this.alignment==="right"){var f=this.handle.positionedOffset(),a=this.getGalleryElement().getDimensions();f.left=a.width-f.left+this.borderWidth();f.top+=this.handleSize.height+this.borderWidth();this.getResizeControls().setStyle({left:(a.width-f.left+this.borderWidth())+"px",width:(f.left-(this.borderWidth()*2))+"px",height:(f.top-(this.borderWidth()*2))+"px"})}else{if(this.alignment==="left"){var f=this.handle.positionedOffset();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.getResizeControls().setStyle({width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}else{if(this.alignment==="center"){var f=this.handle.positionedOffset(),a=this.getGalleryElement().getDimensions();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.getResizeControls().setStyle({left:(a.width-f.left+this.borderWidth())/2+"px",width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}}}},dragEnd:function(f,c){this.dragging=false;Wysija.dragging=false;$$("body")[0].setStyle({cursor:""});var a=this.minWidth(),b=this.getResizeControls().getWidth();if(b<a){b=a}this.setDimensions(b);this.handle.writeAttribute("style","");if(this.alignment==="right"){this.getResizeControls().insert(this.handle);this.getResizeControls().writeAttribute("style","")}else{if(this.alignment==="center"){this.getResizeControls().writeAttribute("style","")}}Wysija.hideTools();this.getGalleryElement().fire("drag:end")},setDimensions:function(a){var a=(a===undefined)?this.maxWidth():a,b=this.maxHeight();this.getGalleryElement().setStyle({width:a+"px",height:b+"px"});this.getResizeControls().setStyle({width:a+"px",height:b+"px"})},borderWidth:function(){return 1*2},createResizeControls:function(){if(this.getResizeControls()!=undefined){return}this.getGalleryElement().insert('<div class="resize-controls"><span class="resize-handle"></span><span class="resize-info"></span></div>')},getResizeControls:function(){return this.getGalleryElement().down(".resize-controls")},getGalleryElement:function(){return this.element.down(".wysija_gallery")}});Wysija.Content=Class.create(Wysija.Block,{contents:null,image:null,constraints:{left:{minWidth:32,maxWidth:325},right:{minWidth:32,maxWidth:325},center:{minWidth:32,maxWidth:564},full:{maxWidth:564}},initialize:function(a){this.element=$(a);if(this.getTextContainer()){this.contents=new Wysija.Text(this.getTextContainer())}if(this.getImageContainer()){this.image=new Wysija.Image(this.getImageContainer())}return this},save:function(){var a={};if(this.contents!=null){a.text=this.contents.save()}if(this.image!=null){a.image=this.image.save();if(this.image.isEmpty()===false){a.alignment=a.image["alignment"]}else{a.alignment="center"}a["static"]=(this.element.hasClassName("static"))}return a},draw:function(){if(this.image===null){this.element.childElements().last().insert(this.drawContainer("image"));this.image=new Wysija.Image(this.getImageContainer());this.image.setOptions(this.getCustomData("image"));this.getImageContainer().insert(this.image.draw())}if(this.contents===null){this.element.childElements().last().insert(this.drawContainer("text"));this.contents=new Wysija.Text(this.getTextContainer());this.contents.setOptions(this.getCustomData("text"));this.getTextContainer().insert(this.contents.draw())}return this},drawContainer:function(a){return'<div class="wysija_'+a+'"></div>'},getImageContainer:function(){return this.element.down(".wysija_image")},getTextContainer:function(){return this.element.down(".wysija_text")},getContainer:function(){return this.element.down(".wysija_content")},minWidth:function(){return this.constraints[this.alignment].minWidth},maxWidth:function(){if(this.isAlone()){return this.constraints.full.maxWidth}else{return this.constraints[this.alignment].maxWidth}},fullWidth:function(){return this.constraints.full.maxWidth},setup:function(){info("content -> setup");this.setupControls();if(this.contents!=null){this.contents.setup()}if(this.image!=null){this.image.setup()}this.constrainSize()},getControls:function(){return this.element.down(".wysija_controls")},remove:function(){if(this.image.isEmpty()&&this.contents.isEmpty()){this.removeBlock()}},setBlockAlignment:function(a){info("content -> set block alignment");this.getContainer().removeClassName("left").removeClassName("center").removeClassName("right");this.getContainer().writeAttribute("wysija_align",a);this.getContainer().addClassName(a);this.alignment=a;if(this.image!=null){this.image.setAlignment(a);this.image.updateDisplay()}if(this.contents!=null){this.contents.setAlignment(a)}this.constrainSize();Wysija.autoSave();return this},constrainSize:function(){info("content -> constrain size");this.image.ratio=this.image.getRatio();var c=this.image.minSize(),a=this.image.maxSize(),f=this.image.getImageElement();if(f.width>a.width||f.height>a.height){this.image.getImageContainer().writeAttribute("style","");f.writeAttribute({width:a.width,height:a.height})}else{if(f.width<c.width||f.height<c.height){this.image.getImageContainer().writeAttribute("style","");f.writeAttribute({width:c.width,height:c.height})}}if(this.image.alignment==="center"){this.image.getImageContainer().setStyle({width:f.readAttribute("width")+"px"})}else{this.image.getImageContainer().setStyle({width:"auto"})}if(this.image.isEmpty()||this.contents.isEmpty()){this.contents.getTextContainer().setStyle({width:"auto",height:"auto","float":"none"});if(this.contents.getTools()){this.contents.getTools().setStyle({right:0})}}else{if(this.contents.isEditing()){this.contents.getTextContainer().setStyle({width:"auto","float":"none"});if(this.contents.getTools()){this.contents.getTools().setStyle({right:0})}switch(this.contents.alignment){case"left":var d=parseInt(this.image.getImageElement().readAttribute("width"));this.contents.getTextContainer().setStyle({width:(this.contents.fullWidth()-d-17)+"px","float":"right"});break;case"right":var d=parseInt(this.image.getImageElement().readAttribute("width"));this.contents.getTextContainer().setStyle({width:(this.contents.fullWidth()-d-17)+"px"});break}this.contents.getTextContainer().setStyle({height:"auto"})}else{this.contents.getTextContainer().setStyle({width:"auto","float":"none"});if(this.contents.getTools()){this.contents.getTools().setStyle({right:0})}if(this.contents.alignment==="right"){if(this.contents.getTools()){if(Prototype.Browser.ie7===false){var d=parseInt(this.image.getImageElement().readAttribute("width"));this.contents.getTools().setStyle({right:(d+15+(2*1))+"px"})}}}if(this.contents.isEmpty()===false){var b=this.contents.getTextArea().getHeight();var e=parseInt(this.image.getImageElement().readAttribute("height"));if(this.contents.alignment==="right"||this.contents.alignment==="left"){if(b<e){this.contents.getTextContainer().setStyle({height:e+"px"})}else{this.contents.getTextContainer().setStyle({height:"auto"})}}else{if(b<20){this.contents.getTextContainer().setStyle({height:20+"px"})}else{this.contents.getTextContainer().setStyle({height:"auto"})}}}}}},getBlock:function(){return this.element.up(".wysija_block")}});var WysijaImageAbstract={initialize:function(a,b){info("image abstract -> init");this.element=$(a);this.elementArea=(b===undefined)?"block":b;this.alignment=this.getDefaultAlignment();this.params=new Hash();return this},save:function(){if(this.isEmpty()){return null}return{src:this.getImageElement().readAttribute("src"),width:parseInt(this.getImageElement().readAttribute("width")),height:parseInt(this.getImageElement().readAttribute("height")),url:this.params.get("url"),alt:this.params.get("alt"),alignment:this.alignment,"static":this.getImageElement().hasClassName("static")}},draw:function(){return this.customDraw()+this.customTools()},customDraw:function(){if(this.getOptions().get("elementSrc")===undefined){this.setOptions({elementSrc:$("wysija_widgets_settings").down(".image").innerHTML,elementRatio:1.76,elementClass:"empty",elementHeight:85,elementWidth:150})}var a=this.getOptions();this.setRatio(a.get("elementRatio")||1);if(this.getImageElement()!=undefined){a.set("elementId",this.getImageElement().identify())}return'<img class="image_placeholder #{elementClass}" id="#{elementId}" src="#{elementSrc}" height="#{elementHeight}" width="#{elementWidth}" />'.interpolate(a)},customTools:function(){if(this.getOptions().get("elementClass")==="empty"){return""}return'<ul class="wysija_tools"><li><a href="javascript:;" title="'+Wysija_i18n.alignmentLeft+'" class="alignment-left"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.alignmentCenter+'" class="alignment-center"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.alignmentRight+'" class="alignment-right"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.addImageLink+'" class="add-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImageLink+'" class="remove-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImage+'" class="remove"><span></span></a></li></ul>'},setupTools:function(){this.tools=this.getTools();if(this.tools){this.leftButton=this.tools.down(".alignment-left");this.leftButton.observe("click",function(){this.setBlockAlignment("left")}.bind(this));this.centerButton=this.tools.down(".alignment-center");this.centerButton.observe("click",function(){this.setBlockAlignment("center")}.bind(this));this.rightButton=this.tools.down(".alignment-right");this.rightButton.observe("click",function(){this.setBlockAlignment("right")}.bind(this));this.addLinkButton=this.tools.down(".add-link");this.addLinkButton.observe("click",function(){this.addLink()}.bind(this));this.removeLinkButton=this.tools.down(".remove-link");this.removeLinkButton.observe("click",function(){this.removeLink()}.bind(this));this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(){this.remove()}.bind(this))}},getTools:function(){return this.element.down(".wysija_tools")},hideTools:function(){this.getTools().hide();if(this.information!=undefined){this.information.hide()}},showTools:function(){this.getTools().show();if(this.information!=undefined){this.information.show()}},addLink:function(){var a=wysijaAJAX.adminurl+"?page=wysija_campaigns&action=image_data";if(this.params.get("url")!==undefined&&this.params.get("url")!==null){a+="&url="+Wysija.encodeURIComponent(this.params.get("url"))}if(this.params.get("alt")!==undefined){a+="&alt="+Wysija.encodeURIComponent(this.params.get("alt"))}WysijaPopup.open(this.element,Wysija_i18n.addLinkTitle,a,this.setData.bind(this),"addlink")},setData:function(a){this.params.set("url",a.url);this.params.set("alt",a.alt);if(this.params.get("url")!==undefined&&this.params.get("url")!==null){this.showLink()}else{this.hideLink()}Wysija.autoSave();Wysija.init()},removeLink:function(){this.params.set("url",null);this.hideLink()},showLink:function(){this.addLinkButton.writeAttribute("title",decodeURIComponent(this.params.get("url")));this.addLinkButton.addClassName("active")},hideLink:function(){this.addLinkButton.writeAttribute("title",Wysija_i18n.addImageLink);this.addLinkButton.removeClassName("active")},setBlockAlignment:function(b){info("image -> set block alignment to : "+b);var a=Wysija.get(this.getBlock());a.block.setBlockAlignment(b)},remove:function(){info("image -> remove");this.element.fire("image:remove")},makeDroppable:function(){info("image -> make droppable");Droppables.add(this.getImageElement().identify(),Wysija.imageDropOptions)},removeDroppable:function(){info("image -> remove droppable");Droppables.remove(this.getImageElement().identify())},setup:function(){info("image -> setup");this.createControls();this.setupControls();this.setupTools();this.makeDroppable();this.getParameters();if(this[this.alignment+"Button"]){this[this.alignment+"Button"].addClassName("active")}return this},getParameters:function(){info("image -> get parameters");var c=this.element.down(".wysija_params");if(c!=undefined&&this.params.keys().length===0){var a=$F(c.down('input[name="url"]'));if(a!=""){this.params.set("url",a);this.showLink()}var b=$F(c.down('input[name="alt"]'));if(b!=""){this.params.set("alt",b)}}return this},createControls:function(){if(this.getImageElement().hasClassName("empty")||this.getImageElement().hasClassName("static")||this.getResizeControls()!=undefined){return}this.element.insert('<div class="resize-controls"><span class="resize-handle"></span><span class="resize-info"></span></div>')},setupControls:function(){if(this.getImageElement().hasClassName("empty")||this.getImageElement().hasClassName("static")){return}this.ratio=this.getRatio();this.controls=this.getControls();this.handle=this.controls.down(".resize-handle");this.information=this.controls.down(".resize-info");this.handleSize=this.handle.getDimensions();this.draggable=new Draggable(this.handle,{onStart:this.dragStart.bind(this),snap:this.dragSnap.bind(this),change:this.dragChange.bind(this),onEnd:this.dragEnd.bind(this),starteffect:false,endeffect:false});return this},getImageContainer:function(){return this.element},getImageElement:function(){return this.element.down("img")},getResizeControls:function(){return this.element.down(".resize-controls")},minSize:function(){var a=this.minWidth(),b;return{width:a,height:Math.ceil(a/this.ratio)}},maxSize:function(){var a=this.maxWidth(),b;return{width:a,height:Math.ceil(a/this.ratio)}},getRatio:function(){return this.getImageContainer().readAttribute("wysija_ratio")||((this.getImageElement().width/this.getImageElement().height)*1000).round()/1000},setRatio:function(a){this.element.writeAttribute("wysija_ratio",a);return this},isEmpty:function(){return this.getImageElement().hasClassName("empty")},setEmpty:function(a){this.getImageContainer()[a?"addClassName":"removeClassName"]("empty")},isAlone:function(){return this.getImageContainer().hasClassName("alone")},setAlone:function(a){this.getImageContainer()[a?"addClassName":"removeClassName"]("alone")},setAlignment:function(a){if(this.isEmpty()){return}info("image -> setAlignment = "+a);this.alignment=a;this.leftButton.removeClassName("active");this.centerButton.removeClassName("active");this.rightButton.removeClassName("active");this[a+"Button"].addClassName("active");return this},getDefaultAlignment:function(){return this.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.imageAlignment},dragStart:function(){Wysija.hideEditors();this.dragging=true;Wysija.dragging=true;$$("body")[0].setStyle({cursor:this.handle.getStyle("cursor")});if(this.alignment==="right"){this.element.insert(this.handle)}},dragSnap:function(a,h,g){var b=this.constraints[this.alignment].minWidth,f=this.constraints[this.alignment].maxWidth;if(this.isAlone()){f=this.constraints.full.maxWidth}if(this.alignment==="right"){var c=this.getImageElement().width,e=c-a;if(e>f){a=c-f;e=f}if(e<b){a=c-b;e=b}h=Math.floor(e/this.ratio-this.handleSize.height)}else{var e=a+this.handleSize.width;if(e>f){a=f-this.handleSize.width;e=f}if(e<b){a=b-this.handleSize.width;e=b}h=Math.floor(e/this.ratio-this.handleSize.height)}return[a,h]},dragChange:function(c,b){if(this.alignment==="right"){var f=this.handle.positionedOffset(),a=this.getImageElement().getDimensions();f.left=a.width-f.left+this.borderWidth();f.top+=this.handleSize.height+this.borderWidth();this.controls.setStyle({left:(a.width-f.left+this.borderWidth())+"px",width:(f.left-(this.borderWidth()*2))+"px",height:(f.top-(this.borderWidth()*2))+"px"})}else{if(this.alignment==="left"){var f=this.handle.positionedOffset();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.controls.setStyle({width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}else{if(this.alignment==="center"){var f=this.handle.positionedOffset(),a=this.getImageElement().getDimensions();f.left+=this.handleSize.width;f.top+=this.handleSize.height;this.controls.setStyle({left:(a.width-f.left+this.borderWidth())/2+"px",width:(f.left-this.borderWidth())+"px",height:(f.top-this.borderWidth())+"px"})}}}this.updateDisplay(true)},dragEnd:function(f,c){this.dragging=false;Wysija.dragging=false;$$("body")[0].setStyle({cursor:""});var a=this.constraints[this.alignment].minWidth,b=this.controls.getWidth();if(b<a){b=a}this.setDimensions(b);this.handle.writeAttribute("style","");if(this.alignment==="right"){this.controls.insert(this.handle);this.controls.writeAttribute("style","");this.element.writeAttribute("style","")}else{if(this.alignment==="center"){this.controls.writeAttribute("style","");this.element.setStyle({width:b+"px"})}else{this.element.writeAttribute("style","")}}Wysija.hideTools();this.element.fire("drag:end")},setDimensions:function(a){var a=(a===undefined)?this.maxWidth():a,b=(a/this.ratio).ceil(),c=this.getImageElement();c.width=a;c.height=b;this.controls.setStyle({width:a+"px",height:b+"px"})},borderWidth:function(){return 1*2},getControls:function(){return this.element.down(".resize-controls")},getInformation:function(){return this.controls.down(".resize-info")},updateDisplay:function(a){if(a===undefined){a=false}this.controls=this.getControls();if(this.controls===undefined){return}this.information=this.getInformation();if(this.information===undefined){return}if(a){var b=this.controls.getDimensions()}else{var b=this.element.getDimensions()}if(this.information!==undefined){this.information.update("#{width} x #{height}".interpolate(b))}}};Wysija.Image=Class.create(Wysija.Content,WysijaImageAbstract);Wysija.BannerImage=Class.create(Wysija.Banner,WysijaImageAbstract);var WysijaGalleryItemAbstract={initialize:function(a,b){info("gallery item -> init");this.element=$(a);this.params=new Hash();return this},save:function(){if(this.isEmpty()){return null}return{src:this.getImageElement().readAttribute("src"),width:parseInt(this.getImageElement().readAttribute("width")),height:parseInt(this.getImageElement().readAttribute("height")),url:this.params.get("url"),alt:this.params.get("alt"),cellWidth:parseInt(this.getImageContainer().getWidth()),cellHeight:parseInt(this.getImageContainer().getHeight())}},draw:function(){return this.customDraw()+this.customTools()},customDraw:function(){if(this.getOptions().get("elementSrc")===undefined){this.setOptions({elementSrc:"",elementRatio:1.48,elementClass:"empty",elementHeight:135,elementWidth:200})}var a=this.getOptions();if(this.getImageElement()!=undefined){a.set("elementId",this.getImageElement().identify())}return'<img class="image_placeholder #{elementClass}" id="#{elementId}" src="#{elementSrc}" height="#{elementHeight}" width="#{elementWidth}" />'.interpolate(a)},customTools:function(){if(this.getOptions().get("elementClass")==="empty"){return""}return'<ul class="wysija_tools"><li><a href="javascript:;" title="'+Wysija_i18n.addImageLink+'" class="add-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImageLink+'" class="remove-link"><span></span></a></li><li><a href="javascript:;" title="'+Wysija_i18n.removeImage+'" class="remove"><span></span></a></li></ul>'},setupTools:function(){this.tools=this.getTools();if(this.tools){this.addLinkButton=this.tools.down(".add-link");this.addLinkButton.observe("click",function(){this.addLink()}.bind(this));this.removeLinkButton=this.tools.down(".remove-link");this.removeLinkButton.observe("click",function(){this.removeLink()}.bind(this));this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(){this.remove()}.bind(this))}},getTools:function(){return this.element.down(".wysija_tools")},hideTools:function(){this.getTools().hide()},showTools:function(){this.getTools().show()},remove:function(){info("gallery item -> remove");this.element.fire("image:remove")},setup:function(){info("gallery item -> setup");this.setupControls();this.setupTools();this.getParameters();return this},getParameters:function(){info("gallery item -> get parameters");var c=this.element.down(".wysija_params");if(c!==undefined&&this.params.keys().length===0){var a=$F(c.down('input[name="url"]'));if(a!=""){this.params.set("url",a)}var b=$F(c.down('input[name="alt"]'));if(b!=""){this.params.set("alt",b)}}return this},getImageContainer:function(){return this.element},getImageElement:function(){return this.element.down("img")},isEmpty:function(){return this.getImageElement().hasClassName("empty")},setEmpty:function(a){this.getImageContainer()[a?"addClassName":"removeClassName"]("empty")},setPosition:function(a){this.element.writeAttribute("wysija_position",a)}};Wysija.GalleryImage=Class.create(Wysija.Gallery,WysijaGalleryItemAbstract);var WysijaTextAbstract={initialize:function(a){this.element=$(a);this.alignment=this.getDefaultAlignment();return this},save:function(){if(this.isEmpty()){return null}return{value:Base64.encode(this.getTextArea().innerHTML)}},draw:function(){info("text -> draw");return this.customDraw()+this.customTools()},customDraw:function(){info("text -> custom draw");var a=this.getOptions();if(this.getTextArea()!=undefined){a.set("elementId",this.getTextArea().identify())}if(a.get("elementText")===undefined){return'<div class="editable text_placeholder empty" id="#{elementId}"></div>'.interpolate(this.getOptions())}else{return'<div class="editable" id="#{elementId}">#{elementText}</div>'.interpolate(this.getOptions())}},makeDroppable:function(){if(this.isDroppable()){Droppables.add(this.getTextArea().identify(),Wysija.textDropOptions)}},removeDroppable:function(){Droppables.remove(this.getTextArea().identify())},hasContent:function(){return(this.getTextArea()!=undefined)},isDroppable:function(){return this.getTextArea().hasClassName("text_placeholder")},isEmpty:function(){return this.getTextArea().hasClassName("empty")},isEditing:function(){return this.element.hasClassName("editing")},setup:function(){info("text -> setup");this.setupEditor();this.setAlignment(this.getDefaultAlignment());this.setupTools();this.makeDroppable()},setAlignment:function(a){info("text -> setAlignment = "+a);this.alignment=a;if(this.isEmpty()===false){this.disableEditor()}return this},getDefaultAlignment:function(){return this.element.up(".wysija_content").readAttribute("wysija_align")||Wysija.defaults.contentAlignment},setBlockAlignment:function(b){info("text -> set block alignment to : "+b);var a=Wysija.get(this.getBlock());a.block.setBlockAlignment(b)},setupEditor:function(){info("text -> setupEditor");this.getTextContainer().observe("click",this.enableEditor.bind(this))},customTools:function(){if(this.getOptions().get("elementText")===undefined){return""}return'<ul class="wysija_tools"><li><a href="javascript:;" title="'+Wysija_i18n.removeText+'" class="remove"><span></span></a></li></ul>'},setupTools:function(){this.tools=this.getTools();if(this.tools){this.removeButton=this.tools.down(".remove");this.removeButton.observe("click",function(a){this.remove();a.stop()}.bind(this))}},getTools:function(){return this.element.down(".wysija_tools")},remove:function(){info("text -> remove");this.element.fire("text:remove")},enableEditor:function(){if(this.isEditing()){return}info("text -> enableEditor");Wysija.hideEditors();this.element.addClassName("editing");tinyMCE.execCommand("mceAddControl",false,this.getTextArea().identify());this.element.fire("editor:enable")},disableEditor:function(){if(this.isEditing()===false){return}info("text -> disableEditor");this.element.removeClassName("editing");tinyMCE.execCommand("mceRemoveControl",false,this.getTextArea().identify());this.element.fire("editor:disable")},setFocus:function(){info("text -> setFocus");this.enableEditor()},getTextContainer:function(){return this.element},getTextArea:function(){return this.element.down(".editable")},getTextEditor:function(){return tinymce.get(this.getTextArea().identify())}};Wysija.Text=Class.create(Wysija.Content,WysijaTextAbstract);Wysija.Divider=Class.create(Wysija.Block,{initialize:function(a){this.element=$(a);this.setOptions(this.getCustomData("divider"));return this},save:function(){if(this.getDivider()===undefined){return null}else{return{src:this.getDivider().readAttribute("src"),width:parseInt(this.getDivider().readAttribute("width")),height:parseInt(this.getDivider().readAttribute("height"))}}},draw:function(){this.element.childElements().last().insert(this.customDraw())},customDraw:function(){info("divider -> custom draw");if(this.getOptions().get("elementSrc")===undefined){this.setOptions({elementSrc:"",elementHeight:1,elementWidth:564})}return'<img class="divider" src="#{elementSrc}" height="#{elementHeight}" width="#{elementWidth}" />'.interpolate(this.getOptions())},customControls:function(){return""},setup:function(){this.setupControls()},getContainer:function(){return this.element.down(".wysija_divider")},getDivider:function(){return this.getContainer().down("img")}});Wysija.Post=Class.create(Wysija.Block,{called:false,initialize:function(a){info("post -> init");this.element=$(a);return this},draw:function(){WysijaPopup.open(this.element,Wysija_i18n.articleSelectionTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=articles",this.callback.bind(this))},callback:function(a){this.called=true;if(a!=undefined&&a!=""){this.success(Base64.decode(a))}else{this.remove()}Wysija.init()},success:function(a){this.element.replace(a)},setup:function(){},remove:function(){Wysija.instances[this.element.identify()]=null;this.element.remove()}});Wysija.AutoPost=Class.create(Wysija.Block,{initialize:function(a){info("autopost -> init");this.element=$(a);return this},draw:function(){info("autopost -> draw")},setup:function(){info("autopost -> setup");this.setupControls()},save:function(){info("autopost -> save");var a={};this.getParameters();a.params=this.params;return a},getParameters:function(){info("autopost -> get parameters");this.params=[];var a=this.element.down(".wysija_params");if(a!=undefined){a.select("input").each(function(b){this.params.push($H({key:b.name,value:b.value}))}.bind(this))}return this},getControls:function(){return this.element.down(".wysija_controls")},setupControls:function(){this.controls=this.getControls();if(this.controls){this.removeButton=this.controls.down(".remove");this.removeButton.observe("click",function(){this.remove();this.removeButton.stopObserving("click")}.bind(this));this.settingsButton=this.element.down(".settings");this.settingsButton.observe("click",function(){this.editSettings()}.bind(this))}return this},editSettings:function(){this.getParameters();var a=this.formatParameters();WysijaPopup.open(this.element,Wysija_i18n.autoPostSettingsTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=autopost&"+a,this.callback.bind(this))},callback:function(a){this.element.replace(Base64.decode(a));Wysija.init()},formatParameters:function(){var a=["autopost_count="+$$(".wysija_auto-post").length,"autopost_type="+$("wysija_widgets_settings").down(".autopost").innerHTML];if(this.params!=undefined&&this.params.length>0){this.params.each(function(b){a.push(b.get("key")+"="+b.get("value"))});a=a.join("&")}return a},loadContent:function(){var d=this.element.previousSiblings();if(d.length>0){var b=[];d.each(function(e){if(e.readAttribute("wysija_type")==="auto-post"){if(e.down('input[name="post_ids"]')!==undefined){b.push(e.down('input[name="post_ids"]').value)}}});if(b.length>0){b=b.join(",")}}this.getParameters();var c=this.formatParameters();if(b!==undefined&&b.length>0){c+="&exclude="+b}var a=this;wysijaAJAX.task="load_auto_post";wysijaAJAX.wysijaData=c;new Ajax.Request(wysijaAJAX.ajaxurl,{method:"post",asynchronous:false,parameters:wysijaAJAX,onSuccess:function(e){a.getAutoPostElement().update(Base64.decode(e.responseJSON.result));Wysija.setSettingsPosition()},onFailure:function(e){}})},remove:function(){info("autopost remove");this.removeBlock(function(){Wysija.initAutoPost()})},getAutoPostElement:function(){return this.element.down(".wysija_auto-post")},getSettings:function(){return this.element.down(".wysija_settings")}});Wysija.PopupAutoPost=Class.create(Wysija.Block,{called:false,initialize:function(a){info("popup auto post -> init");this.element=$(a);return this},draw:function(){var a=["autopost_count="+parseInt($$(".wysija_auto-post").length+1),"autopost_type="+$("wysija_widgets_settings").down(".autopost").innerHTML].join("&");WysijaPopup.open(this.element,Wysija_i18n.autoPostSettingsTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=autopost&"+a,this.callback.bind(this))},callback:function(a){this.called=true;if(a!=undefined&&a!=""){this.success(Base64.decode(a))}else{this.remove()}Wysija.init()},success:function(a){this.element.replace(a)},setup:function(){},remove:function(){Wysija.instances[this.element.identify()]=null;this.element.remove()}});Wysija.PopupDivider=Class.create(Wysija.Block,{called:false,initialize:function(a){info("bookmark -> init");this.element=$(a);return this},draw:function(){WysijaPopup.open(this.element,Wysija_i18n.bookmarkSelectionTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=dividers",this.callback.bind(this))},callback:function(a){this.called=true;if(a!=undefined&&a!=""){this.success(Base64.decode(a))}else{this.remove()}Wysija.init()},success:function(a){this.element.replace(a)},setup:function(){},remove:function(){Wysija.instances[this.element.identify()]=null;this.element.remove()}});Wysija.PopupBookmark=Class.create(Wysija.Block,{called:false,initialize:function(a){info("popup bookmark -> init");this.element=$(a);return this},draw:function(){var a="theme="+$("wysija_widgets_settings").down(".theme").innerHTML;WysijaPopup.open(this.element,Wysija_i18n.bookmarkSelectionTitle,wysijaAJAX.adminurl+"?page=wysija_campaigns&action=bookmarks&"+a,this.callback.bind(this))},callback:function(a){this.called=true;if(a!=undefined&&a!=""){this.success(Base64.decode(a))}else{this.remove()}Wysija.init()},success:function(a){this.element.replace(a)},setup:function(){},remove:function(){Wysija.instances[this.element.identify()]=null;this.element.remove()}});var WysijaPopup={instance:null,getInstance:function(){return WysijaPopup.instance},open:function(b,e,a,d,c){WysijaPopup.instance=new Wysija.Popup(b.identify(),e,a,d,c)},close:function(){tb_remove();WysijaPopup.reset()},reset:function(){WysijaPopup.instance=null}};Wysija.Popup=Class.create({initialize:function(b,e,a,d,c){this.element=$(b);this.title=e;this.url=a;this.callback=d;this.classWindow=c;this.open();return this},open:function(){info("popup -> open");tb_show(this.title,this.url+"&KeepThis=true&TB_iframe=true",null,this.classWindow)},close:function(){if(this.element.hasClassName("wysija_block")){var a=Wysija.get(this.element);if(a.block.called===false){a.block.remove();WysijaPopup.reset()}}return true}});Wysija.DraggableItem=Class.create({initialize:function(a){this.elementType=$(a).readAttribute("wysija_type");this.element=$(a).down()||$(a);this.clone=this.cloneElement();this.insert()},STYLES:new Template("position: absolute; top: #{top}px; left: #{left}px;"),cloneElement:function(){var e=this.element.clone(),d=this.element.cumulativeOffset(),c=document.viewport.getScrollOffsets(),b=this.getList(),a=this.STYLES.evaluate({top:d.top+c.top-b.scrollTop,left:d.left+c.left-b.scrollLeft});e.setStyle(a);e.addClassName("wysija_widget");e.addClassName(this.elementType);if(this.elementType==="image"){e.writeAttribute({elementRatio:this.calculateRatio(),wysija_type:this.elementType})}else{e.innerHTML=this.element.innerHTML}return e},getOffset:function(){return this.element.offsetTop-this.getList().scrollTop},getList:function(){return this.element.up("ul")},insert:function(){$$("body")[0].insert(this.clone)},onMousedown:function(a){var b=new Draggable(this.clone,{scroll:window,onStart:function(){Droppables.displayArea(b)},onEnd:function(c){c.destroy();c.element.remove();Droppables.hideArea()},starteffect:function(c){new Effect.Opacity(c,{duration:0.2,from:c.getOpacity(),to:0.7})},endeffect:Prototype.emptyFunction});b.initDrag(a);b.startDrag(a);return b},calculateRatio:function(){var a=(this.element.readAttribute("wysija_width")/this.element.readAttribute("wysija_height"));return(a*1000).round()/1000}});Object.extend(Wysija.DraggableItem,Observable).observe('a[class="wysija_item"]');Wysija.BlockControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging===true||Wysija.showingTools===true){return}if(this.element.hasClassName("wysija_block")&&this.element.down(".wysija_controls")&&this.element.down(".wysija_controls").visible()===false){this.element.down(".wysija_controls").show();if(this.element.down(".wysija_settings")&&this.element.down(".wysija_settings").visible()===false){this.element.down(".wysija_settings").show()}this.element.addClassName("hover")}},onMouseout:function(a){if(Wysija.dragging===true||Wysija.showingTools===true){return}if(this.element.hasClassName("wysija_block")&&this.element.down(".wysija_controls")&&this.element.down(".wysija_controls").visible()===true){this.element.down(".wysija_controls").hide();if(this.element.down(".wysija_settings")&&this.element.down(".wysija_settings").visible()===true){this.element.down(".wysija_settings").hide()}this.element.removeClassName("hover")}}});Object.extend(Wysija.BlockControlBars,Observable).observe(".wysija_block");Wysija.ImageControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging===true){return}if(this.element.down(".wysija_tools")&&this.element.hasClassName("wysija_image")){this.element.down(".wysija_tools").show();Wysija.hideBlockControls();Wysija.showingTools=true}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()===false){this.element.down(".resize-controls").show()}},onMouseout:function(a){if(Wysija.dragging===true){return}if(this.element.hasClassName("wysija_image")){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").hide();Wysija.hideBlockControls();Wysija.showingTools=false}}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()===true){if(this.element.down(".wysija_tools")){this.element.down(".resize-controls").hide()}}}});Object.extend(Wysija.ImageControlBars,Observable).observe(".wysija_image");Wysija.TextControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging===true){return}if(this.element.hasClassName("wysija_text")&&this.element.hasClassName("editing")===false){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").show();Wysija.hideBlockControls();Wysija.showingTools=true}}},onMouseout:function(a){if(Wysija.dragging===true){return}if(this.element.hasClassName("wysija_text")){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").hide();Wysija.showingTools=false}}}});Object.extend(Wysija.TextControlBars,Observable).observe(".wysija_text");Wysija.GalleryControlBars=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(a){if(Wysija.dragging===true){return}if(this.element.down(".wysija_tools")&&this.element.hasClassName("wysija_gallery")){this.element.down(".wysija_tools").show();Wysija.hideBlockControls()}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()===false){this.element.down(".resize-controls").show()}},onMouseout:function(a){if(Wysija.dragging===true){return}if(this.element.hasClassName("wysija_gallery")){if(this.element.down(".wysija_tools")){this.element.down(".wysija_tools").hide();Wysija.hideBlockControls()}}if(this.element.down(".resize-controls")&&this.element.down(".resize-controls").visible()===true){if(this.element.down(".wysija_tools")){this.element.down(".resize-controls").hide()}}}});Object.extend(Wysija.GalleryControlBars,Observable).observe(".wysija_gallery");Wysija.ImagePreview=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(c){if(Wysija.dragging===true){return}var e=this.element.down("img").clone();if(e.readAttribute("wysija_src")===""){return}var d=e.readAttribute("wysija_height"),b=e.readAttribute("wysija_width"),a=((b/d)*1000).round()/1000;if(b>275){b=275}d=(b/a).round();e.writeAttribute("src",e.readAttribute("wysija_src"));$("wj_images_preview").insert(e);$("wj_images_preview").down("img").writeAttribute("width",b);$("wj_images_preview").down("img").writeAttribute("height",d);$("wj_images_preview").show()},onMouseout:function(a){$("wj_images_preview").update("");$("wj_images_preview").hide()}});Object.extend(Wysija.ImagePreview,Observable).observe(".wj_images li a");Wysija.ThemePreview=Class.create({initialize:function(a){this.element=$(a)},onMouseover:function(c){if(Wysija.dragging===true){return}var e=this.element.down("img").clone();if(e.readAttribute("wysija_src")===""){return}var d=e.readAttribute("wysija_height"),b=e.readAttribute("wysija_width"),a=((b/d)*1000).round()/1000;if(b>275){b=275}d=(b/a).round();e.writeAttribute("src",e.readAttribute("wysija_src"));$("wj_themes_preview").insert(e);$("wj_themes_preview").down("img").writeAttribute("width",b);$("wj_themes_preview").down("img").writeAttribute("height",d);$("wj_themes_preview").show()},onMouseout:function(a){$("wj_themes_preview").update("");$("wj_themes_preview").hide()}});Object.extend(Wysija.ThemePreview,Observable).observe(".wj_themes li a");Wysija.ToolbarTabs=Class.create({initialize:function(a){this.element=$(a)},onClick:function(a){if(Wysija.dragging===true){return}$$("#"+Wysija.options.toolbar+" .tabs a").invoke("removeClassName","selected");$$(".wj_images, .wj_content, .wj_styles, .wj_themes").invoke("hide");$$(".wj_"+a.target.rel)[0].show();$(a.target).addClassName("selected")}});Object.extend(Wysija.ToolbarTabs,Observable).observe("#"+Wysija.options.toolbar+" .tabs a");Wysija.TextLinks=Class.create({initialize:function(a){this.element=$(a)},onClick:function(a){a.stop();return false}});Object.extend(Wysija.TextLinks,Observable).observe(".editable a");window.document.observe("mousedown",function(a){if(tinymce.editors.length>0){if(a.target.id==="mceModalBlocker"){return}if(a.target.hasClassName("mceClose")){return}if(a.target.up(".wysija_text")===undefined){if(a.target.up(".editable")===undefined){if(a.target.hasClassName("mceText")===false){Wysija.hideEditors();Wysija.autoSave()}}}}});function debug(a){if(Wysija.options.debug===false){return}try{console.log("[DEBUG] "+a)}catch(b){}}function info(a){if(Wysija.options.debug===false){return}try{console.log("[INFO] "+a)}catch(b){}}document.on("image:drop",function(b,c){var a=Wysija.get(c.up(".wysija_block")||c.up(".wysija_header")||c.up(".wysija_footer"));a.block.image.removeDroppable();a.block.image.setOptions(b.memo);a.block.getImageContainer().writeAttribute("style","");a.block.getImageContainer().update(a.block.image.draw());a.block.image.setup();if(a.block.contents===undefined){a.block.image.setAlone(true)}else{a.block.image.setAlone(a.block.contents.isEmpty());a.block.setBlockAlignment(a.block.contents.getDefaultAlignment())}a.block.image.setEmpty(false);a.block.constrainSize();Wysija.hideTools();Wysija.autoSave()});document.on("text:drop",function(b,c){var a=Wysija.get(c.up(".wysija_block"));a.block.contents.removeDroppable();a.block.contents.setOptions(b.memo);a.block.getTextContainer().update(a.block.contents.draw());a.block.contents.setup();if(a.block.image.isEmpty()===false){a.block.image.setAlone(false);a.block.setBlockAlignment(a.block.image.alignment)}a.block.constrainSize();a.block.contents.setFocus();Wysija.hideControls();Wysija.hideTools();Wysija.autoSave()});document.on("image:remove",function(b,c){var a=Wysija.get(c.up(".wysija_block")||c.up(".wysija_header")||c.up(".wysija_footer"));a.block.image.removeDroppable();a.block.image.setOptions({elementSrc:undefined});a.block.image.element.update(a.block.image.draw());a.block.image.makeDroppable();a.block.image.setEmpty(true);a.block.constrainSize();a.block.remove()});document.on("text:remove",function(b,c){var a=Wysija.get(c.up(".wysija_block"));a.block.contents.getTextContainer().stopObserving("click");a.block.contents.removeDroppable();a.block.contents.setOptions({elementText:undefined});a.block.contents.element.update(a.block.contents.draw());a.block.contents.makeDroppable();if(a.block.image.isEmpty()===false){a.block.image.setAlone(true);a.block.setBlockAlignment(Wysija.defaults.imageAlignment)}a.block.constrainSize();a.block.remove()});document.on("editor:enable",function(b,c){var a=Wysija.get(c.up(".wysija_block"));a.block.constrainSize()});document.on("editor:disable",function(b,c){var a=Wysija.get(c.up(".wysija_block"));a.block.constrainSize()});document.on("block:insert",function(b,c){var a=Wysija.get(c);if(a.elementType==="content"){a.block.image.setAlone(a.block.contents.isEmpty());a.block.image.setEmpty(a.block.image.isEmpty());a.block.constrainSize()}});document.on("drag:end",function(b,c){var a=Wysija.get(c.up(".wysija_block")||c.up(".wysija_header")||c.up(".wysija_footer"));a.block.constrainSize()});